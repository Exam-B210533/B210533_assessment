---
title: "**Construct data dictionary in R**"
author: "B210533"
date: "`r format (Sys.time (), '%d %B, %Y')`"
output: html_document
---
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Data Dictionary Overview

This data dictionary provides information about data from the ONS Mortality data collected using the The Jupyter Notebook data collection tool saved at "./ipynbScripts/data_collection_tool.ipynb". The output is saved as an R dataset (.rds) in the 'RawData' folder.

# Data
#### Load packages

```{r load, message = FALSE, warning=FALSE}
library(dataMeta)
library (tidyverse)
library(here)
```

#### Load the data 

```{r data, message = FALSE, warning=FALSE}
collected_data_final=read_csv(here("RawData", "collected_data_final.csv"))
```

#### View the data 
```{r glimpse1, message = FALSE, warning=FALSE}
glimpse(collected_data_final) 
```
The collected_data_final data set contains: 
  * **category_1:** character, containing the names of the groups for counts, e.g. "Total deaths", "all ages". 
  * **category_2**: character, subcategory of names of groups where necessary, e.g. details of region: "East", details of age bands "15-44". 
  * **counts:** integer, actual number of deaths in whole numbers. 
  * **date:** date, format is yyyy-mm-dd; all dates are a Friday.
  * **week_no:**  integer, each week in a year is numbered sequentially.
  * **mort_avg** float, average mortality for the 5-years prior to date
  * **variance_from_avg** float, difference between actual mortality and 5-year average as a proportion
  * **consent:** the consent from the end-user to process and share the data collected with the data capture tool.

# Build a data dictionary

### Change the date format to character
The data dictionary functions used below work more effectively with character type data rather than date type data, tehrefore the date column is transformed. 
```{r dateformat}
collected_data_final$date <- as.character(collected_data_final$date)
```

### Build a linker data frame
Create two string vectors representing the different variable descriptions and the different variable types.

#### Variable Descriptions
Create the variable descriptions
```{r variable_description}
variable_description <- c("The index column that allows us to link the data collected to the original ons_mortality data in the 'RawData' folder.",
                          "The week in the year that this activity relates to, with numbers starting from January.",
                          "The year that this activity relates to.", 
                          "The date of the Friday of the week that this activity relates to.", 
                          "The count of deaths in that week.",  
                          "The average count of deaths in the same week using data from the previous 5-years",
                          "The difference between the actual deaths in the week compared to the 5-year average as a proportion (double)",
                          "The consent from the end-user to process and share the data collected with the data capture tool.")
```

#### Variable Types
There are six quantitative values variables and two fixed values (allowable values or codes) variables.
```{r variable_types}
variable_type <- c(0, 0, 0, 1, 0, 0, 0, 1)
print(variable_type)
```

#### Build the Linker
The collected_data_final variable names, variable_description and variable_type string vectors are brought together in a intermediary (linker) data frame. 

```{r build_linker}
linker<-build_linker(collected_data_final, variable_description, variable_type)
```

#### Create the data dictionary 
The build_dict function is used to create a data frame using the linker (and the variable names, variable descriptions and variable types) to create the data dictionary. 
```{r build_dictionary}
dictionary <- build_dict(my.data = collected_data_final, linker = linker, option_description = NULL, prompt_varopts = FALSE)
glimpse(dictionary)

```
 
#### Save the data dictionary
the data is saved to the RawData folder. 
```{r save_data1, message = FALSE, warning = FALSE}
write_csv(dictionary, here("RawData", "collected_data_dictionary.csv"))
```

## Append data dictionary to the collected_data_final
#### Create main_string for attributes
An introductory description for the data set is created to be added as meta data alongside the data dictionary below.
```{r main_string}
main_string <- "This data describes the NHS England Mortality data and running 5 years averages from the *NHSRdatasets* package collected by the data capture tool."
main_string
```
#### Incorporate attributes as metada
```{r complete_dataset}
complete_collected_data <- incorporate_attr(my.data = collected_data_final, data.dictionary = dictionary,
                                           main_string = main_string)
#Change the author name
attributes(complete_collected_data)$author[1]<-"B210533"
complete_collected_data
attributes(complete_collected_data)
```

##### Save collected_data_final with attributes

```{r save_it}
save_it(complete_collected_data, here("RawData", "complete_collected_data"))
```
###### Save RDS
```{r readRDS}
complete_collected_data <- readRDS(here("RawData", "complete_collected_data.rds"))
```